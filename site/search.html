<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Suche – Epstein Files</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
<div class="topbar">
  <div class="container">
    <div class="row">
      <div class="badge"><span class="dot"></span><strong>Live</strong> · <span id="today"></span></div>
      <div class="badge">Status: <span id="authState">Gast</span> · <a href="#" id="logoutBtn" style="display:none">Logout</a></div>
    </div>
  </div>
</div>

<div class="masthead">
  <div class="container">
    <div class="inner">
      <div class="logo">
        EPSTEIN FILES
        <small>Index + Leseführung für öffentlich zugängliche Quellen · Premium: Highlights, Smart‑Match, Namen‑Index</small>
      </div>
      <div class="actions">
        <a class="btn" href="/admin.html">Admin</a>
        <a class="btn primary" href="#" data-subscribe>Freischalten <small>ab €1,99</small></a>
      </div>
    </div>
  </div>
</div>

<div class="nav">
  <div class="container">
    <div class="row">
      <a href="/">Start</a>
      <a href="/search.html">Suche</a>
      <a href="/names.html">Namen‑Index</a>
      <a href="/about.html">Methode</a>
      <a href="/partners.html">Partner</a>
    </div>
  </div>
</div>

<main class="container">
  <div class="grid" style="grid-template-columns:1fr .8fr;margin-top:16px">
    <div>
      <div class="card pad">
        <div class="kicker">Suche</div>
        <div class="h2">Finde das Relevante – schnell</div>
        <form id="searchForm" class="searchbar">
          <input id="searchInput" type="search" placeholder="z.B. Name, Gericht, Fluglog, Insel…" autocomplete="off">
          <button type="submit">Suchen</button>
        </form>
        <div class="p small muted" id="status"></div>
      </div>

      <div class="card" style="margin-top:18px">
        <div class="pad" style="border-bottom:1px solid var(--line)">
          <div class="kicker">Ergebnisse</div>
          <div class="h2" id="resultTitle">—</div>
        </div>
        <div class="list" id="resultList"></div>
      </div>
    </div>

    <aside>
      <div class="card pad">
        <div class="kicker">Premium Smart Match</div>
        <div class="p">
          Wenn deine Suche Premium‑Highlights triggert, zeigen wir dir das (ohne Inhalte zu leaken).
          Premium schaltet die Highlights dann frei.
        </div>
        <a class="btn primary" href="#" data-subscribe>Freischalten ab €1,99</a>
        <hr>
        <div id="matchBox" class="premiumLock" style="display:none">
          <h4>Premium Match vorhanden</h4>
          <div class="p small">Für „<span id="matchQuery"></span>“ existieren Premium‑Highlights.</div>
          <a class="btn danger" href="#" data-subscribe>Jetzt freischalten</a>
        </div>
      </div>
    </aside>
  </div>
</main>

<script type="module">
  import { apiGet, esc } from "/js/api.js";
  import { boot } from "/js/render.js";

  function qs(s){return document.querySelector(s)}
  function renderItem(d) {
    return `
    <div class="item">
      <div class="title"><a href="/a/${encodeURIComponent(d.slug)}">${esc(d.title)}</a></div>
      <div class="meta"><span>${esc(d.source_name||"")}</span><span>·</span><span>${d.published_at ? new Date(d.published_at).toLocaleDateString("de-DE") : ""}</span></div>
      <div class="p small muted">${esc((d.public_summary||d.excerpt||"").slice(0,220))}${(d.public_summary||d.excerpt||"").length>220?"…":""}</div>
      ${d.has_premium_match ? '<div class="p small"><span class="hl">Premium Match</span> zu deiner Suche vorhanden.</div>' : ''}
    </div>`;
  }

  async function run(q) {
    qs("#resultTitle").textContent = q ? `„${q}“` : "—";
    qs("#status").textContent = q ? "Suche läuft…" : "Bitte Suchbegriff eingeben.";
    qs("#matchBox").style.display = "none";
    if (!q) return;

    const data = await apiGet(`/api/documents?q=${encodeURIComponent(q)}&limit=30`);
    if (!data.success) {
      qs("#status").textContent = data.error || "Fehler";
      return;
    }
    qs("#status").textContent = `${data.pagination.total} Treffer`;
    qs("#resultList").innerHTML = (data.data || []).map(renderItem).join("");

    const hasMatch = (data.data || []).some(x => x.has_premium_match);
    const token = localStorage.getItem("premium_token");
    if (hasMatch && !token) {
      qs("#matchQuery").textContent = q;
      qs("#matchBox").style.display = "block";
    }
  }

  boot("search").then(async () => {
    const params = new URLSearchParams(location.search);
    const q = (params.get("q") || "").trim();
    qs("#searchInput").value = q;
    await run(q);

    qs("#searchForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const q2 = qs("#searchInput").value.trim();
      history.replaceState(null, "", `/search.html?q=${encodeURIComponent(q2)}`);
      await run(q2);
    });
  });
</script>

<div class="footer">
  <div class="container">
    <div class="row">
      <div>© <span id="year"></span> Wissens‑Bank. <span class="muted">Recherche‑Index & Leseführung.</span></div>
      <div style="display:flex;gap:12px;flex-wrap:wrap">
        <a href="/impressum.html">Impressum</a>
        <a href="/datenschutz.html">Datenschutz</a>
        <a href="/agb.html">AGB</a>
      </div>
    </div>
    <div style="margin-top:10px" class="p small muted">
      Hinweis: Wir hosten keine urheberrechtlich geschützten Inhalte Dritter. Wir verlinken auf Quellen und erstellen Zusammenfassungen/Leseführung.
    </div>
  </div>
</div>
<script>document.getElementById("year").textContent = new Date().getFullYear();</script>


<!-- Deployed with Zip-Ship -->
<div id="zipship-badge" style="position:fixed;bottom:12px;right:12px;z-index:9999;font-family:system-ui,sans-serif;font-size:12px;">
  <a href="https://zip-ship-revolution.com/?utm_source=user_site" target="_blank" rel="noopener" 
     style="display:flex;align-items:center;gap:6px;padding:6px 12px;background:rgba(10,14,39,0.85);color:#00F0FF;text-decoration:none;border-radius:6px;border:1px solid rgba(0,240,255,0.3);backdrop-filter:blur(8px);transition:all 0.2s;">
    <span style="font-size:14px;">⚡</span>
    <span>Deployed with Zip-Ship</span>
  </a>
</div>
</body>
</html>
